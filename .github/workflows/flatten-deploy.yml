# Railway Deployment Setup Instructions:
# 1. Create new Railway service from GitHub repo: bryntje/alphapy
# 2. Set branch to: deploy
# 3. Set Root Directory: /
# 4. Config File Path: railway.toml
# 5. The workflow will flatten shared/innersync-core/ and update Dockerfile paths

name: Flatten Submodule & Deploy

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  flatten-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Remove submodule .git directory
      run: rm -rf shared/innersync-core/.git

    - name: Move submodule contents to root
      run: |
        cp -r shared/innersync-core/* ./
        cp shared/innersync-core/.* ./ 2>/dev/null || true
        rm -rf shared/

    - name: Update Dockerfile.dashboard for flattened structure
      run: |
        sed -i 's|shared/innersync-core/package.json shared/innersync-core/pnpm-lock.yaml|package.json pnpm-lock.yaml|g' Dockerfile.dashboard
        sed -i 's|COPY shared/innersync-core/ .|COPY . .|g' Dockerfile.dashboard

    - name: Force push to deploy branch
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git checkout -b deploy || git checkout deploy
        git add .
        git commit -m "Flatten submodule for Railway deployment" --allow-empty
        git push origin deploy --force
